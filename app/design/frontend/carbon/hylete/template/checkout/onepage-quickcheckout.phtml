<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<div class="container-fluid checkout-container">

<h1>
    <?php echo $this->__('checkout'); ?>
    <a href="<?php echo Mage::helper('core/url')->getHomeUrl();?>" id="continue-shopping-checkout" class="continue-shopping">&laquo; <?php echo $this->__('continue shopping') ?></a>
</h1>

<script type="text/javascript">countryRegions = <?php echo $this->helper('directory')->getRegionJson() ?></script>

<?php if( Icommerce_Default::isModuleActive('Icommerce_QuickCheckoutCart') ): ?>
	<?php if( Mage::helper('quickcheckoutcart')->isActive() ): ?>
		<div id="quickcheckoutcart-cart-container" class="row quickcheckout-cart-container">
            <?php echo $this->getChildHtml('quickcheckoutcart.cart') ?>
		</div>
	<?php endif; ?>
<?php endif; ?>

<?php if(Mage::getModel('checkout/type_onepage')->getQuote()->getHasError()): ?>
    <ul class="messages row">
        <li class="error-msg col-md-12">
            <ul>
                <li><?php echo $this->__('Requested amount of at least one of the products is not in stock. Please go back to the cart and update.');?></li>
            </ul>
        </li>
    </ul>
    <script type="text/javascript">
        //<![CDATA[
        Event.observe(window, 'load', function(e){
            $('place-order-button').writeAttribute("disabled", "disabled");
            $('place-order-button').setOpacity(0.5);
        });
        //]]>
    </script>
<?php endif; ?>

<?php $_steps = $this->getSteps(); ?>

<?php // grouping steps by columns
    $_stepsGrouped = array(
        '1' => array('billing' => null, 'shipping' => null),
        '2' => array('shipping_method' => null),
        '3' => array('payment' => null),
        '4' => array('review' => null)
    );
?>

<?php // steps titles
    $_stepsTitles = array(
        'billing' => '1.&nbsp;your details',
        'shipping_method' => '2.&nbsp;shipping',
        'payment' => '3.&nbsp;payment',
        'review' => '4.&nbsp;your order'
    );
?>

<?php
    $_processedSteps = array();
    foreach ($_steps as $_stepId => $_stepInfo): ?>
        <?php foreach ($_stepsGrouped as $_columnIndex => $_columnOrder): ?>
            <?php $add = false; ?>
            <?php if (array_key_exists($_stepId, $_columnOrder)): ?>
                <?php $add = true; ?>
            <?php elseif ($_columnIndex == 'other'): ?>
                <?php $add = true; ?>
            <?php endif; ?>
            <?php if($add && !in_array($_stepId, $_processedSteps)): ?>
                <?php $_processedSteps[] = $_stepId;
                $_stepsGrouped[$_columnIndex][$_stepId] = $_stepInfo; ?>
            <?php endif; ?>
        <?php endforeach; ?>
    <?php endforeach;
?>

<div id="checkoutSteps" class="one-page-checkout row">
    <?php foreach($_stepsGrouped as $_stepsGroupedIndex => $_stepsGroup): ?>
        <?php if(count($_stepsGroup)) : ?>
            <ul class="section col-lg-3 col-md-6 col-sm-6 col-xs-12">
                <?php foreach($_stepsGroup as $_stepId => $_stepInfo): ?>
                    <?php if ($_stepId == 'shipping_method' && !$this->getChild($_stepId)->isShow()):?>
                        <div id="checkout-step-<?php echo $_stepId ?>">
                            <?php if (isset($_stepsTitles[$_stepId])) : ?>
                            <div class="checkout-step__title">
                                <?php echo $this->__($_stepsTitles[$_stepId]); ?>
                            </div>
                            <?php endif; ?>
                            <div class="content-container">
                                <?php echo $this->__("Electronic gift card is sent immediately to the recipient's email after purchase."); ?>
                            </div>
                        </div>
                        
                    <?php else:?>
                        <?php if ((!$this->getChild($_stepId) || !$this->getChild($_stepId)->isShow())): continue; endif; ?>
                        
                        <li id="opc-<?php echo $_stepId ?>" <?php if($_stepId == 'shipping'):?> style="display:none;"<?php endif; ?>>
                            <div id="checkout-step-<?php echo $_stepId ?>">
                                <?php if (isset($_stepsTitles[$_stepId])) : ?>
                                <div class="checkout-step__title">
                                    <?php echo $this->__($_stepsTitles[$_stepId]); ?>
                                </div>
                                <?php endif; ?>
                                <div class="content-container">
                                    <?php echo $this->getChildHtml($_stepId) ?>
                                </div>
                            </div>
                        </li>
                    <?php endif;?>
                <?php endforeach; ?>
            </ul>
        <?php endif; ?>
    <?php endforeach; ?>
</div>
</div>
<script type="text/javascript">
    //<![CDATA[
    var accordion = new Accordion('checkoutSteps', '.head', true);
    <?php if($this->getActiveStep()): ?>
    accordion.openSection('opc-<?php echo $this->getActiveStep() ?>');
    <?php endif ?>

    var checkout = new Checkout(accordion,{
            progress: '<?php echo $this->getUrl('checkout/onepage/progress') ?>',
            review: '<?php echo $this->getUrl('checkout/onepage/review') ?>',
            saveMethod: '<?php echo $this->getUrl('checkout/onepage/saveMethod') ?>',
            failure: '<?php echo $this->getUrl('checkout/cart') ?>'}
    );

    // Icommerce QuickCheckout Begin
    var urlToGetShippingMethodsHtml = '<?php echo $this->getUrl('quickcheckout/QuickCheckout/getShippingMethodsHtml') ?>';
    var urlToGetPaymentMethodsHtml = '<?php echo $this->getUrl('quickcheckout/QuickCheckout/getPaymentMethodsHtml') ?>';

    var urlToAddCoupon = '<?php echo $this->getUrl('quickcheckout/ajax/addCoupon') ?>';
    var urlToAddGiftCard = '<?php echo $this->getUrl('quickcheckout/ajax/addGiftCard') ?>';
    var urlToRemoveGiftCard = '<?php echo $this->getUrl('quickcheckout/ajax/removeGiftCard') ?>';

    var qcPrimaryBillingAddress = false;
    var qcPrimaryShippingAddress = false;

    <?php
        if(Icommerce_Default::isLoggedIn()):
	    	if((bool)Mage::getStoreConfig('quickcheckout/settings/autofill_customer_address')):

				$customerAddressId = Mage::getSingleton('customer/session')->getCustomer()->getDefaultBilling();
				$defaultBillingAddress = false;

				if ($customerAddressId):
					$defaultBillingAddress = Mage::getModel('checkout/type_onepage')->getAddress($customerAddressId); // We use this module to split up street aaddress
                    $defaultBillingAddress->unsStreet();
				endif;

		    	if($defaultBillingAddress !== false):
		    	?>
    var qcDefaultBillingAddress = '<?php echo Zend_Json::encode($defaultBillingAddress) ?>';
    <?php
    endif;

    $customerAddressId = Mage::getSingleton('customer/session')->getCustomer()->getDefaultShipping();

    $defaultShippingAddress = false;

    if ($customerAddressId):
        $defaultShippingAddress = Mage::getModel('checkout/type_onepage')->getAddress($customerAddressId); // We use this module to split up street aaddress
        $defaultShippingAddress->unsStreet();
    endif;

    if($defaultShippingAddress !== false):
    ?>
    var qcDefaultShippingAddress = '<?php echo Zend_Json::encode($defaultShippingAddress) ?>';
    <?php
    endif;
endif;
endif;
?>

    var quickCheckout;
    Event.observe(window, 'load', function() {
        quickCheckout = new QuickCheckout();
        quickCheckout.addEventListenerToSaveOrderButton();
    });
    // Icommerce QuickCheckout End

    //]]>
</script>